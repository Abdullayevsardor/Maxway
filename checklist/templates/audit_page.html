{% extends "base.html" %}

{% block title %}Audit Natijalari{% endblock %}

{% block content %}

<h2>Audit natijalari</h2>

<form method="GET" class="filters">
    <select name="filial">
        <option value="all">Barcha filiallar</option>
        {% for f in all_filials %}
            <option value="{{ f }}" {% if request.GET.filial == f %}selected{% endif %}>{{ f }}</option>
        {% endfor %}
    </select>

    <input type="date" name="from" value="{{ request.GET.from }}">
    <input type="date" name="to" value="{{ request.GET.to }}">
    <button type="submit">Filtrlash</button>

    <div class="export-buttons">
        <!-- Excel Export -->
        <a href="{% url 'audit_export_excel' %}?{% if request.GET.filial %}filial={{ request.GET.filial }}&{% endif %}{% if request.GET.from %}from={{ request.GET.from }}&{% endif %}{% if request.GET.to %}to={{ request.GET.to }}{% endif %}"
           class="excel">Excel Export</a>

        <!-- PDF Export -->
        <a href="{% url 'audit_export_pdf' %}?{% if request.GET.filial %}filial={{ request.GET.filial }}&{% endif %}{% if request.GET.from %}from={{ request.GET.from }}&{% endif %}{% if request.GET.to %}to={{ request.GET.to }}{% endif %}"
           class="pdf">PDF Export</a>
    </div>
</form>
<div class="table-container">
    <table>
        <thead>
            <tr>
                <th>Filial nomi</th>
                <th>Umumiy foiz</th>
                <th>Sana</th>
                <th>Amallar</th>
            </tr>
        </thead>

        <tbody>
            {% for audit in audits %}
            <tr>
                <td>
                    <a href="{% url 'audit_filial_detail' audit.filial_nomi %}">
                        {{ audit.filial_nomi }}
                    </a>
                </td>
                <td>{{ audit.percent }}%</td>
                <td>{{ audit.created_at|date:"Y-m-d H:i" }}</td>
                <td>
                    <form method="POST" action="{% url 'audit_delete' audit.id %}"
                        onsubmit="return confirm('Rostdan ham o‘chirmoqchimisiz?');">
                        {% csrf_token %}
                        <button type="submit"
                                style="background:#f44336;color:white;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;">
                            O‘chirish
                        </button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}


{% block extra_head %}
<style>
/* 1. Umumiy sozlamalar */
body { 
    font-family: Arial, sans-serif; 
    padding: 10px; 
    background: #eef3f4; 
    margin: 0;
    overflow-x: hidden; /* Butun sahifa surilishini cheklash */
}

h2 { text-align: center; font-size: 1.2rem; margin: 15px 0; }

/* 2. Filtrlar (Mobilda ixchamroq) */
.filters {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    background: #fff;
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 15px;
}
.filters select, .filters input[type="date"], .filters button {
    flex: 1 1 calc(50% - 10px); /* Ikkita element bir qatorda */
    min-width: 0; 
    font-size: 14px;
    padding: 8px;
}
.filters button { flex: 1 1 100%; background: #4CAF50; color: white; border: none; border-radius: 4px; }

/* 3. Eksport tugmalari */
.export-buttons { display: flex; gap: 8px; width: 100%; margin-top: 5px; }
.export-buttons a {
    flex: 1;
    padding: 8px;
    text-align: center;
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 12px;
}
.export-buttons a.excel { background: #2196F3; }
.export-buttons a.pdf { background: #f44336; }

/* 4. JADVALNI JIGARIDAN TUTISH (Scrollni yo'qotadigan qism) */
table {
    width: 100% !important;
    table-layout: fixed; /* MAJBURIY QOIDA: Ustunlar kengligini qat'iy qiladi */
    border-collapse: collapse;
    background: #fff;
    word-wrap: break-word; /* Uzun so'zlarni bo'ladi */
}

th, td {
    border: 1px solid #ccc;
    padding: 6px 2px; /* Yonlardagi padding minimal */
    text-align: center;
    font-size: 11px; /* Mobilda sig'ishi uchun shrift kichik */
    overflow: hidden;
}

th { background: #d3edf4; }

/* Ustunlarga aniq foiz beramiz */
th:nth-child(1), td:nth-child(1) { width: 30%; } /* Filial nomi */
th:nth-child(2), td:nth-child(2) { width: 15%; } /* Foiz */
th:nth-child(3), td:nth-child(3) { width: 30%; } /* Sana */
th:nth-child(4), td:nth-child(4) { width: 25%; } /* Amallar */

/* O'chirish tugmasini kichraytirish */
td button {
    width: 100%;
    font-size: 10px !important;
    padding: 4px 2px !important;
}

/* Sana matnini maydalash */
td:nth-child(3) {
    font-size: 10px;
    line-height: 1.1;
}

/* 5. Agar baribir sig'masa, jadvalni o'zini alohida suriladigan qilish */
.table-container {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}
</style>
{% endblock %}
