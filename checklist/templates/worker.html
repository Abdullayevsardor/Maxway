{% extends "base.html" %}
{% load static %}

{% block title %}–§–æ—Ä–º–∞ –∞—É–¥–∏—Ç–∞{% endblock %}
{% block extra_head %}

<style>
*, *::before, *::after { box-sizing: border-box; }

/* Umumiy stil */
body { font-family: Arial, sans-serif; background-color: #eef3f4 !important; margin: 0; padding: 0px; }
h1 { text-align: center; color: #333; margin-bottom: 18px; }

/* Agar navigatsiya paneli o'chmasa, uni majburan yashirish */
.action-bar {
  display: none !important;
}

/* Markazdagi formani ko'rinadigan qilish */
.container {
  background: transparent;
  position: relative;
  z-index: 10; /* Kontent fonning ustida turishi uchun */
}


/* Audit form container */
.audit-card {
  background: #fff;
  padding: 16px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,.08);
}

/* Filial kiritish overlay */
#filialInputOverlay {
  position: fixed; inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 9999;
  padding: 16px;
}
#filialInputBox {
   
  width: 95%; /* Ekran chetidan 5% joy qolsin */
  max-width: 400px;
  padding: 20px;
  margin: 0 auto;
}
#filialInput {
    height: 50px; /* Barmoq bilan bosish oson bo'lishi uchun */
    font-size: 18px; /* iOS-da zoom bo'lib ketmasligi uchun (16px+ bo'lishi shart) */
}
#filialInputBox h2 { margin: 0 0 10px; }
#filialInput {
  padding: 10px 12px;
  margin: 12px 0;
  width: 100%;
  border: 1px solid #dfe7ea;
  border-radius: 10px;
  font-size: 16px;
}
#startAuditBtn {
  width: 100%;
  display: block;
  min-height: 44px;
  padding: 12px 14px;
  background-color: #2a87ea;
  color: #fff;
  border: none;
  border-radius: 10px;
  cursor: pointer;
}

/* Jadval */
.table-wrap { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
table { width: 100%; border-collapse: collapse; margin-bottom: 16px; min-width: 100%; background: #fff; }
th, td {
  border: 1px solid #161717;
  padding: 8px;
  text-align: left;
  word-wrap: break-word;
  vertical-align: top;
}
th { background-color: #d3edf4; text-align: center; font-size: 0.95em; }

th:first-child, td:first-child { width: 50%; text-align: center; }
.subheader-row th { background-color: #9ccadf; font-style: italic; text-align: left; font-size: 1em; }

.score-column { width: 25%; text-align: center; }
.image-column { width: 25%; }

/* Ball input */
.score-input {
  width: 90%;
  max-width: 90px;
  border: 1px solid #110f0f;
  padding: 6px 0;
  margin: 0 auto 5px;
  text-align: center;
  font-size: 16px;
  font-weight: bold;
  display: block;
}

/* Bo‚Äòsh qolgan score inputni aniq ko‚Äòrsatish */
.score-input.invalid {
  border: 2px solid #e92b41 !important;
  box-shadow: 0 0 0 3px rgba(233, 43, 65, 0.25) !important;
}


/* Xohlasangiz bo‚Äòsh qolgan katakning fonini ham biroz qizartiramiz */
td.score-column.invalid-cell {
  background: rgba(233, 43, 65, 0.08) !important;
}

/* Ranglar */
.green { background-color: #50ed6f !important; }
.yellow { background-color: #dec046 !important; }
.red { background-color: #e92b41 !important; }
.default { background-color: rgb(253, 251, 251) !important; }

/* Rasm upload */
.image-container { display: block; }
.image-preview-wrapper {
  position: relative;
  display: inline-block;
  margin-top: 6px;
  cursor: pointer;
  max-width: 90%;
}
.image-preview {
  max-width: 110px;
  max-height: 160px;
  height: auto;
  object-fit: contain;
  border: 2px solid #89bcf3;
  border-radius: 6px;
  display: block;
}
.delete-btn {
  position: absolute;
  top: -10px;
  right: -10px;
  background-color: red;
  color: white;
  border: 1px solid white;
  border-radius: 50%;
  width: 26px;
  height: 26px;
  text-align: center;
  line-height: 26px;
  font-size: 14px;
  font-weight: bold;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.2s;
  z-index: 10;
}
.image-preview-wrapper:hover .delete-btn { opacity: 1; }
.overlay-actions {
  margin-top: 12px;
  display: flex;
  gap: 8px;
  justify-content: center;
}

.overlay-actions .o-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 8px 60px;
  min-height: 36px;
  font-size: 13px;
  border-radius: 10px;
  text-decoration: none;
  background: #ced2d6;
  color: #000;
}

.overlay-actions .o-btn.warning {
  background: #ced2d6;
  color: #000;
}

/* Mobil uchun maxsus tweaklar */
@media (max-width: 600px) {
    th, td {
        padding: 5px 2px; /* Bo'shliqni kamaytirdik */
        font-size: 11px;  /* Shriftni kichraytirdik */
    }
    
    .score-input {
        width: 100%; /* Ball kiritish joyi katakni to'ldirsin */
        font-size: 14px;
        padding: 4px 0;
    }

    .image-preview {
        max-width: 60px; /* Rasmlarni kichraytirdik */
        max-height: 80px;
    }
}


input[type="file"] {
    max-width: 100%;
    font-size: 11px;
    padding: 2px;
    display: block;
    overflow: hidden;
    color: transparent; /* "–§–∞–π–ª –Ω–µ –≤—ã–±—Ä–∞–Ω" yozuvini yashirish uchun (ixtiyoriy) */
    
}

input[type="file"]::-webkit-file-upload-button {
    font-size: 10px; /* Tugmaning o'zini ichidagi yozuvni kichraytirish */
    margin-top: 8px;    /* Tugmani yozuvdan pastga suradi */
    margin-bottom: 5px; /* Pastki chiziqqa yopishib qolmasligi uchun */
    padding: 3px 0;    /* Tugma ichidagi bo'shliq */
}

@media (max-width: 480px) {
    .image-column {
        width: 60% !important; /* Ustunni biroz kengaytirdik */
    }
    input[type="file"] {
        font-size: 0px;
    }
    /* Jadval sig'ishi uchun majburiy qoida */
    table {
        min-width: 100% !important; 
    }
 


</style>
{% endblock %}

{% block content %}


<div id="filialInputOverlay">
  <div id="filialInputBox">
    <h2>–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–∞</h2>

    <input type="text" id="filialInput" placeholder="–Ω–∞–∑–≤–∞–Ω–∏–µ" required>

    <!-- ASOSIY TUGMA -->
    <button type="button" id="startAuditBtn">
      –ù–∞—á–∞—Ç—å –∞—É–¥–∏—Ç
    </button>
    <p></p>
    <div class="top-nav-buttons" style="display: flex; gap: 10px;  margin-bottom: 15px;">
        {% if request.user.is_authenticated %}
            <a href="{% url 'audit_page' %}" class="o-btn" style="flex: 1; text-align: center; background: #ced2d6; padding: 10px; border-radius: 10px; text-decoration: none; color: #000;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</a>
            <a href="{% url 'low_scores' %}" class="o-btn warning" style="flex: 1; text-align: center; background: #ced2d6; padding: 10px; border-radius: 10px; text-decoration: none; color: #000;">‚ö† –ù–∏–∑–∫–∏–µ –±–∞–ª–ª—ã</a>
        {% endif %}
    </div>

    <!-- üîΩ FAQAT NATIJA VA PAST BALLAR -->
   
  </div>
</div>



<h1 id="mainTitle" style="display:none;">[Filial nomi] –§–æ—Ä–º–∞ –∞—É–¥–∏—Ç–∞</h1>

<div class="top-nav-buttons" style="display: flex; gap: 10px; margin-bottom: 15px;">
    {% if request.user.is_authenticated %}
        <a href="{% url 'audit_page' %}" class="o-btn" style="flex: 1; text-align: center; background: #ced2d6; padding: 10px; border-radius: 10px; text-decoration: none; color: #000;">üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã</a>
        <a href="{% url 'low_scores' %}" class="o-btn warning" style="flex: 1; text-align: center; background: #ced2d6; padding: 10px; border-radius: 10px; text-decoration: none; color: #000;">‚ö† –ù–∏–∑–∫–∏–µ –±–∞–ª–ª—ã</a>
    {% endif %}
</div>

<div style="font-weight:600; margin-bottom:10px;">
  –ê—É–¥–∏—Ç–æ—Ä: {{ request.session.auditor_username }}
</div>
<div class="audit-card">
  <form id="auditForm"  method="POST" action="{% url 'audit_form' %}" enctype="multipart/form-data" style="display:none">
    {% csrf_token %}

    <input type="hidden" id="hiddenFilialName" name="filial_nomi" value="">
    <input type="hidden" id="hiddenTotalPercentage" name="total_percentage" value="">

    <h2 id="totalPercentHeader">–ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç: 0.00%</h2>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã</th>
            <th style="width: 100px;">–ë–∞–ª–ª (0-3)</th>
            <th style="width: 250px;">–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ</th>
          </tr>
        </thead>
        <tbody id="audit-body"></tbody>
      </table>
    </div>

    <div style="text-align:right;">
      <button type="submit" class="btn btn-success" style="min-width:220px;">
        –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
      </button>
    </div>
  </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
const successUrl = "{% url 'audit_success' %}";

const AUDIT_DATA = [
  { bandId: "hujjatlar", text: "Hujjatlar saqlanishi (arxiv/papka)" },
  // { bandId: "oxknv", text: "OXKNV chek-listi" },
  { bandId: "xodimlar_chek_listi", text: "Xodimlar chek-listi (ishga kirishayotgan)" },
  // { bandId: "dezinfeksiya_jurnali", text: "Dezinfeksiya jurnali" },
  // { bandId: "bakteritsid_lampa", text: "Bakteritsid lampa jurnali" },
  { bandId: "tibbiy_koriklar", text: "Tibbiy ko'riklar (o'tmaganlar soni) [-1: 2; -2: 1; -3: 0]" },
  // { bandId: "sanminimum", text: "Sanminimum (guvohnomasi yo'q xodimlar soni) [-1: 2; -2: 1; -3: 0]" },
  { bandId: "dezinfeksiya_shartnomasi", text: "Dezinfeksiya shartnomasi va aktlari" },
  { bandId: "qol_yuvish_zaxirasi", text: "Qo'l yuvish vositasi zaxirasi" },
  { bandId: "dori_qutisi", text: "Dori qutisidagi dori vositalari ro'yxatga asosanmi" },
  // { bandId: "termometr_metrologiya", text: "Termometr va psixrometrlar metrologiyadan o'tkazilganmi [-1: 2; -2: 1; -3: 0]" },
  // { bandId: "tarozilar_metrologiya", text: "Tarozilar metrologiyadan o'tkazilganmi [-1: 2; -2: 1; -3: 0]" },

  { bandId: "oshxona_subheader", text: "Oshxona", subheader: true },
  { bandId: "oshxona_qol_yuvish", text: "Oshxona: Tozalik cheklisti" },
  { bandId: "oshxona_tozalik_sifati", text: "Oshxona: Tozalik sifati (pol, devor, plintuslar)" },
  { bandId: "oshxona_anjom_tamgasi", text: "Oshxona: Devor, pol qoplamalarining holati" },
  { bandId: "oshxona_xom_pishgan", text: "Oshxona: Kirishda qo'l yuvish vositalari barchasi mavjud" },
  { bandId: "oshxona_saqlash_muddatlari", text: "Oshxona: Har soatda qo'l yuvish tartibiga rioya qilinishi" },
  { bandId: "oshxona_joylashtirish", text: "Oshxona: Anjom va ish stollari tamg'alangan, maqsadli ishlatilishi" },
  { bandId: "oshxona_idish_almashtirish", text: "Oshxona: Anjom va idishlar holati (materiali, sirti va h.)" },
  { bandId: "oshxona_bitta_anjom", text: "Oshxona: Mahsulotlarning birlamchi saqlash muddatlari" },
  { bandId: "oshxona_bodring_marinad", text: "Oshxona: Mahsulotlarning ikkilamchi saqlash muddatlari" },
  { bandId: "oshxona_tozalash_vositalari", text: "Oshxona: Idishlar har safar yangi mahsulot solishda almashtiriladimi" },
  { bandId: "oshxona_harorat", text: "Oshxona: Sosiskalar savdo hajmiga mos miqdorda archib qo'yilganmi" },
  { bandId: "oshxona_sovutgich_joyi", text: "Oshxona: To'g'ralgan tuzlangan bodring o'z marinad suvida saqlanadimi" },
  { bandId: "oshxona_issiqlik", text: "Oshxona: Sovutgich va muzlatgichlar termometri bormi" },
  { bandId: "oshxona_gosht_aralashmasligi", text: "Oshxona: Sovutgich va muzlatgichda mahsulot qo'shnichiligiga rioya qilinishi" },
  { bandId: "oshxona_fritur_muddat", text: "Oshxona: Sovutgich va muzlatgich ichining tozalik holati" },
  { bandId: "oshxona_fritur_talab", text: "Oshxona: Kotlet pishirish anjomlari tamg'alanganmi" },
  { bandId: "oshxona_ovqat_qoldigi", text: "Oshxona: Xom va pishgan g'o'sht aralashishiga yo'l qo'yilmaydimi" },
  { bandId: "oshxona_chiqindi_urna", text: "Oshxona: Pishgan go'shtni multiholderda saqlash muddatiga rioya qilinishi" },
  { bandId: "oshxona_issiq_suv", text: "Oshxona: Frityur yog'i talabga javob beradimi" },
  { bandId: "oshxona_dezozvita", text: "Oshxona: Chips baki tamg'alanganmi, tozaligi" },
  { bandId: "oshxona_Ishchi_yuzalar_chun_dezvosita_tayyorlanganmi", text: "Oshxona: Chiqindi urnalari to'lishi 2/3 qismdan oshmagan, qopqog'I yopiq" },
  { bandId: "oshxona_Oshxona_o'rikonlar_tozaligi", text: "Oshxona: Mo'rikonlar tozaligi" },
  { bandId: "oshxona_Ishchi_yuzalar_uchun_dezvosita_tayyorlanganmi", text: "Oshxona: Ishchi yuzalar uchun dezvosita tayyorlanganmi (2 chelak)" },


  { bandId: "salatxona_subheaderi", text: "Salatxona", subheader: true },
  { bandId: "salatxona_tozalik", text: "Salatchi: Tozalik cheklisti" },
  { bandId: "salatxona_anjom_yuvish_suv", text: "Salatchi: Tozalik sifati (pol, devor, plintuslar)" },
  { bandId: "salatxona_harorat", text: "Salatchi: Devor, pol qoplamalarining holati" },
  { bandId: "salatxona_sovutgich_rioya", text: "Salatchi: Nazorat termometri bor, harorat talab darajasida" },
  { bandId: "salatxona_mahsulot_qoshniligi", text: "Salatchi: Sovutgich va muzlatgich ichining tozalik holati" },
  { bandId: "salatxona_maxsus_qoidalar", text: "Salatchi: Sovutgich ichida mahsulot qo'shnichiligi" },
  { bandId: "salatxona_anjomlar_maqsad", text: "Salatchi: Mahsulotlar ikkilamchi saqlash muddatlari belgilangan" },
  { bandId: "salatxona_anjom_toza", text: "Salatchi: Anjomlar maqsadlii ishlatiladi (pichoq, taxtakach va h.)" },
  { bandId: "salatxona_sabzavot_urna", text: "Salatchi: Xodim sabzavot va ko'kat yuvish yo'riqnomasiga asosan ishlaydi" },
  { bandId: "salatxona_sovuq_ishlov_", text: "Salatchi: Sabzavot va ko'kat qoldiqlari uchun urna tamg'alangan" },
 
  { bandId: "moykova_subheader", text: "Moyka", subheader: true },
  { bandId: "moykova_tozalik", text: "Moyka: Tozalik cheklisti" },
  { bandId: "moykova_qoplamalar", text: "Moyka: Tozalik sifati (pol, devor, plintuslar)" },
  { bandId: "moykova_yuvish_vositalari", text: "Moyka: Devor, pol qoplamalarining holati" },
  { bandId: "moykova_chotka", text: "Moyka: Anjom va idishlar yuvilishi yo'riqnomaga asosan" },
  { bandId: "moykova_yuvish_jarayoni", text: "Moyka: Anjom va idish yuvish uchun chotka va b. vositalar holati" },
  { bandId: "moykova_toza_anjom", text: "Moyka: Stellaj holati, tamg'alanganligi" },
  { bandId: "moykova_kir_anjom", text: "Moyka: Toza anjomlar saqlanishi, maxsus konteyner mavjudmi" },
  { bandId: "moykova_jiroluvittel_tozaligi", text: "Moyka: Jiroulovitel chek-listi" },
  { bandId: "moykova_jiroluvittel_dezinfeksiya", text: "Moyka: Jiroulovitel tozaligi" },
  { bandId: "moykova_ovqat_qoldigi_urna", text: "Moyka: Yuvish anjomlarini dezinfeksiyasi uchun idish tamg'alangan" },
  { bandId: "moykova_ishchi_kiyim", text: "Moyka: Ovqat qoldiqlari uchun urna tamg'alangan, 2/3 to'lganda tozalanadi" },
  { bandId: "moykova_dezmodda_tayyorlash", text: "Moyka: Dezmodda zaxirasi" },
  // { bandId: "moyka_Dezmodda_to'g'ri_tayyorlanishi", text: "Moyka: Dezmodda to'g'ri tayyorlanishi va qo'llanishi (konsentratsiya)" },

  { bandId: "ombor_subheader", text: "Ombor", subheader: true },
  { bandId: "ombor_harorat", text: "Ombor: Tozalik sifati (pol, devor, plintuslar)" },
  { bandId: "ombor_saqlash_muddat", text: "Ombor: Termometr va psixrometr soz. Harorat va namlik talab darajasida" },
  { bandId: "ombor_stellajlar", text: "Ombor: Stellajlar tamg'alangan va maqsadli ishlatiladi" },
  { bandId: "ombor_joylashuv", text: "Ombor: Stellajlar tagi va usti tozalangan va begona buyumlar yo'q" },
  { bandId: "ombor_yaroqlilik_sanasi", text: "Ombor: Mahsulotlar qo'shnichiligiga rioya qilinishi (oziq/nooziq va h.)" },
  { bandId: "ombor_tozalash_vositalari", text: "Ombor: Mahsulotlar yerda saqlanishiga yo'l qo'yilmagan" },
  // { bandId: "ombor_quruq_hol", text: "Ombor: Taralar markerlangan, mahsulotlar tara nomiga asosan joylashtirilgan" },
  { bandId: "ombor_muzlatgich_termometr", text: "Ombor: Muddati o'tgan mahsulotlar yo'q" },
  // { bandId: "ombor_mahsulot_qoshniligi", text: "Ombor: Sovutgich va muzlatgich nazorat termometrlari bor" },
  { bandId: "ombor_harorat_qoshniligi", text: "Ombor: Sovutgich va muzlatgich kamerada yoritish manbasi soz" },
  { bandId: "ombor_tartib", text: "Ombor: Sovutgich va muzlatgichda mahsulot qo'shnichiligi" },
  { bandId: "ombor_qadoqlangan", text: "Ombor: Sovutgich va muzlatgich ichining tozalik holati" },
  { bandId: "ombor_begona_buyumlar", text: "Ombor: Qadoqlar yopiq holda (korobkasi yopiq)" },
  { bandId: "ombor_Begonabuyumlar_mavjudmi", text: "Ombor: Begona buyumlar mavjudmi" },

  { bandId: "koridor_subheader", text: "Koridor", subheader: true },
  { bandId: "koridor_tozalik", text: "Koridor: Tozalik holai" },
  { bandId: "koridor_tosiq", text: "Koridor: Mahsulot bilan to'sib qo'yilmagan" },
  { bandId: "koridor_qoplama", text: "Koridor: Devor va pollar qoplamasi holati" },
  { bandId: "koridor_begona_narsalar", text: "Koridor: Kimyoviy vositalar shkafida begona narsalar bormi, qulflanadimi" },
  { bandId: "koridor_dezbarer", text: "Koridor: Xodimlar hojatxonasidan chiqishda dezbar'yer bormi" },
  { bandId: "koridor_bezaklar", text: "Koridor: Mop uchun xona yoki joy ajratilganmi" },
  { bandId: "koridor_mop_yuvish", text: "Koridor: Mop anjomlari yo'riqnomaga asosan yuviladi, zararsizlantiriladi" },
  { bandId: "koridor_mop_sarasizlantirish", text: "Koridor: Mop anjomlarini quritish uchun alohida moslamalar mavjud" },
  { bandId: "koridor_mop_saqlash", text: "Koridor: Mop anjomlari saqlanishi (Hojatxona anjomlari alohida)" },
  

  { bandId: "zal_subheader", text: "Zal", subheader: true },
  { bandId: "zal_tozalik", text: "Zal: Tozalik chek-listi" },
  { bandId: "zal_dezinfeksiya", text: "Zal: Tozalik holati" },
  { bandId: "zal_hojatxona_pol_dez", text: "Zal: Mijozdan keyin stollarni dezinfeksiya qilinishi" },
  { bandId: "zal_hojatxona_tozalik", text: "Zal: Patnislar tozalik holati (mijozdan keyin va smena oxirida tozalanishi)" },
  { bandId: "zal_qol_yuvish", text: "Zal: Zaldan oshxonaga kirishda dezbar'yer" },
  { bandId: "zal_hojatxona_vosita", text: "Zal: Qo'l yuvish vositalari to'liq va soz" },
  { bandId: "zal_hojatxona_eshik_yeli", text: "Zal: Hojatxona tozalash chek-listi" },
  { bandId: "zal_hojatxona_tozalik_vosita_2", text: "Zal: Hojatxona tozalik holati" },

  { bandId: "personal_subheader", text: "Personal", subheader: true },
  { bandId: "personal_kiyim_holati", text: "Personal: Xodimlar ish kiyimining holati" },
  { bandId: "personal_kiyim", text: "Personal: Xodimlar tirnog'i, sochi, soqoli" },
  { bandId: "personal_zargarlik", text: "Personal: Zargarlik va shunga o'xshash buyumlar bilan ishlash" },
  { bandId: "personal_yurish", text: "Personal: Xodimlar kiyim almashtirish xonasi va dush holati" },
  { bandId: "personal_kiyim_saqlash", text: "Personal: Xodimlar shaxsiy kiyimi va ish kiyimi saqlanishi" },
  { bandId: "personal_qol_yuvish", text: "Personal: Operatsiya almashtirganda kompaniya standartlariga rioya qilishi" },

  { bandId: "hudud_subheader", text: "Hudud", subheader: true },
  { bandId: "hudud_tozalash_jixoz", text: "Hudud: Korxona tashqi hududini tozalash jixozlari uchun joy" },
  { bandId: "hudud_sanitariya", text: "Hudud: Tashqi oynalar tozaligi" },
  { bandId: "hudud_deraza_tor", text: "Hudud: Ko'chaga qaragan derazalar hasharotga qarshi to'r bilan to'silganmi" },
  { bandId: "hudud_dezinfeksiya", text: "Hudud: Kemiruvchilarga qarshi tuzoqlar yetarlimi (tashqarida va ichkarida)" },
  { bandId: "hudud_trotuar", text: "Hudud: Trotuar va ariqlar tozaligi" },
  { bandId: "hudud_dezinfeksiya_talab", text: "Hudud: Chiqindi yig'ish joyining talabga javob berishi (maydoni, tozalash)" }
];

// --- Global ---
let currentFilialName = '';
let allScores = {};

function getColorClass(score) {
  score = parseInt(score);
  if (score === 3) return 'green';
  if (score === 2) return 'yellow';
  if (score === 1 || score === 0) return 'red';
  return 'default';
}

function updatePercentage() {
  let totalScore = 0;
  let maxPossibleScore = 0;

  document.querySelectorAll('tr[data-band-id]').forEach(row => {
    maxPossibleScore += 3;
    const scoreInput = row.querySelector('.score-input');
    const score = scoreInput ? parseInt(scoreInput.value) : NaN;
    if (!isNaN(score)) totalScore += score;
  });

  const finalPercentage = maxPossibleScore > 0 ? (totalScore / maxPossibleScore) * 100 : 0;

  document.getElementById('totalPercentHeader').textContent = `–ò—Ç–æ–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ–Ω—Ç: ${finalPercentage.toFixed(2)}%`;
  document.getElementById('hiddenTotalPercentage').value = finalPercentage.toFixed(2);
}

// function createScoreInput(bandId, tdElement) {
//   const input = document.createElement('input');
//   input.type = 'number';
//   input.className = 'score-input';
//   input.min = '0';
//   input.max = '3';
//   input.placeholder = '0-3';
//   input.name = `score_${bandId}`;
//   input.id = `score_${bandId}`;

//   input.addEventListener('input', function() {
//     let score = this.value.trim();
//     if (score !== '' && (parseInt(score) < 0 || parseInt(score) > 3 || score.length > 1)) {
//       this.value = '';
//       score = '';
//     }

//     tdElement.classList.remove('green', 'yellow', 'red', 'default');
//     tdElement.classList.add(getColorClass(score));

//     if (!allScores[bandId]) allScores[bandId] = { score: '', images: [] };
//     allScores[bandId].score = score;
//     setInvalidState(this, this.value.trim() === '');

//     updatePercentage();
//   });

//   tdElement.appendChild(input);
//   tdElement.classList.add('default');

//   if (!allScores[bandId]) allScores[bandId] = { score: '', images: [] };
// }
// bandText kiritilganiga ishonch hosil qiling ‚¨áÔ∏è
function createScoreInput(bandId, tdElement, bandText) { 
  const input = document.createElement('input');
  input.type = 'number';
  input.className = 'score-input';
  input.min = '0';
  input.max = '3';
  input.placeholder = '0-3';
  
  // ‚úÖ Endi 'name' xususiyati to'liq matndan iborat bo'ladi
  input.name = `score_${bandText}`; 
  input.id = `score_${bandId}`;

  input.addEventListener('input', function() {
    let score = this.value.trim();
    if (score !== '' && (parseInt(score) < 0 || parseInt(score) > 3 || score.length > 1)) {
      this.value = '';
      score = '';
    }
    tdElement.classList.remove('green', 'yellow', 'red', 'default');
    tdElement.classList.add(getColorClass(score));

    if (!allScores[bandId]) allScores[bandId] = { score: '', images: [] };
    allScores[bandId].score = score;
    updatePercentage();
  });

  tdElement.appendChild(input);
  tdElement.classList.add('default');
}
function createImageUploaders(bandId, tdElement) {
  const inputContainer = document.createElement('div');
  inputContainer.classList.add('image-container');
  inputContainer.id = `input_container_${bandId}`;

  const previewContainer = document.createElement('div');
  previewContainer.classList.add('image-preview-container');
  previewContainer.id = `preview_container_${bandId}`;

  const i = 1;

  const label = document.createElement('label');
  label.textContent = `–ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–æ—Ç–æ`;
  label.htmlFor = `image_${bandId}_${i}`;

  const input = document.createElement('input');
  input.type = 'file';
  input.accept = 'image/*';
  input.name = `image_${bandId}_${i}`;
  input.id = `image_${bandId}_${i}`;
  //input.setAttribute('capture', 'environment'); // ‚úÖ telefon bo‚Äòlsa orqa kamera
  // setAttribute o'rniga shunday yozib ko'ring:
  input.capture = "environment";                              
  //input.capture = "camera";

  input.addEventListener('change', function(e) {
    handleImageUpload(e, bandId, i, previewContainer, inputContainer, input);
  });

  inputContainer.appendChild(label);
  inputContainer.appendChild(input);

  tdElement.appendChild(inputContainer);
  tdElement.appendChild(previewContainer);
}
 

async function handleImageUpload(e, bandId, index, previewContainer, inputContainer, fileInput) {
  const file = e.target.files[0];
  const maxFileSize = 5 * 1024 * 1024;

  previewContainer.innerHTML = '';
  if (!file) return;

  if (!file.type.startsWith('image/')) {
    alert('–ó–∞–≥—Ä—É–∂–∞–π—Ç–µ —Ç–æ–ª—å–∫–æ —Ñ–∞–π–ª—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π!');
    fileInput.value = '';
    return;
  }

  if (file.size > maxFileSize) {
    alert('–†–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –Ω–µ –¥–æ–ª–∂–µ–Ω –ø—Ä–µ–≤—ã—à–∞—Ç—å 5 –ú–ë!');
    fileInput.value = '';
    return;
  }

  inputContainer.style.display = 'none';

  // üîΩ Rasmni o‚Äòqiymiz
  const img = new Image();
  const reader = new FileReader();

  reader.onload = () => {
    img.src = reader.result;
  };

  img.onload = async () => {
    const canvas = document.createElement('canvas');

    let width = img.width;
    let height = img.height;
    const maxSide = 1280;

    if (width > height && width > maxSide) {
      height *= maxSide / width;
      width = maxSide;
    } else if (height > maxSide) {
      width *= maxSide / height;
      height = maxSide;
    }

    canvas.width = width;
    canvas.height = height;

    const ctx = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0, width, height);

    // üî• SIQISH (JPEG 70%)
    const blob = await new Promise(resolve =>
      canvas.toBlob(resolve, 'image/jpeg', 0.7)
    );

    const compressedFile = new File([blob], file.name, {
      type: 'image/jpeg',
      lastModified: Date.now()
    });

    // üîÅ inputga qayta joylaymiz
    const dt = new DataTransfer();
    dt.items.add(compressedFile);
    fileInput.files = dt.files;

    // üëÅ PREVIEW
    const previewURL = URL.createObjectURL(blob);
    const wrapper = document.createElement('div');
    wrapper.classList.add('image-preview-wrapper');

    const previewImg = document.createElement('img');
    previewImg.src = previewURL;
    previewImg.classList.add('image-preview');

    const deleteBtn = document.createElement('div');
    deleteBtn.classList.add('delete-btn');
    deleteBtn.textContent = 'X';

    deleteBtn.onclick = () => {
      fileInput.value = '';
      previewContainer.innerHTML = '';
      inputContainer.style.display = 'block';
    };

    wrapper.appendChild(previewImg);
    wrapper.appendChild(deleteBtn);
    previewContainer.appendChild(wrapper);
  };

  reader.readAsDataURL(file);
}


// function populateTable() {
//   const tbody = document.getElementById('audit-body');
//   tbody.innerHTML = '';

//   AUDIT_DATA.forEach(data => {
//     const row = document.createElement('tr');

//     if (data.subheader) {
//       row.classList.add('subheader-row');
//       row.innerHTML = `<th colspan="3">${data.text}</th>`;
//     } else {
//       row.setAttribute('data-band-id', data.bandId);

//       const bandTd = document.createElement('td');
//       bandTd.textContent = data.text;
//       row.appendChild(bandTd);

//       const scoreTd = document.createElement('td');
//       scoreTd.classList.add('score-column');
//       createScoreInput(data.bandId, scoreTd);
//       row.appendChild(scoreTd);

//       const imageTd = document.createElement('td');
//       imageTd.classList.add('image-column');
//       createImageUploaders(data.bandId, imageTd);
//       row.appendChild(imageTd);
//     }

//     tbody.appendChild(row);
//   });

//   updatePercentage();
// }

function populateTable() {
  const tbody = document.getElementById('audit-body');
  tbody.innerHTML = '';

  AUDIT_DATA.forEach(data => {
    const row = document.createElement('tr');

    if (data.subheader) {
      row.classList.add('subheader-row');
      row.innerHTML = `<th colspan="3">${data.text}</th>`;
    } else {
      row.setAttribute('data-band-id', data.bandId);

      const bandTd = document.createElement('td');
      bandTd.textContent = data.text; // Bu ekranda savol matnini ko'rsatadi
      row.appendChild(bandTd);

      const scoreTd = document.createElement('td');
      scoreTd.classList.add('score-column');
      
      // ‚úÖ MUHIM: data.text uchinchi argument sifatida berildi
      createScoreInput(data.bandId, scoreTd, data.text); 
      
      row.appendChild(scoreTd);

      const imageTd = document.createElement('td');
      imageTd.classList.add('image-column');
      createImageUploaders(data.bandId, imageTd);
      row.appendChild(imageTd);
    }

    tbody.appendChild(row);
  });

  updatePercentage();
}

// Start button
document.getElementById('startAuditBtn').addEventListener('click', (e) => {
  e.preventDefault();

  const inputElement = document.getElementById('filialInput');
  const filialName = inputElement.value.trim();

  if (!filialName) {
    alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ñ–∏–ª–∏–∞–ª–∞.");
    inputElement.focus();
    return; // ‚õî ochilmaydi
  }

  currentFilialName = filialName;
  document.getElementById('hiddenFilialName').value = filialName;

  document.getElementById('filialInputOverlay').style.display = 'none';
  toggleBaseBar();

  document.getElementById('mainTitle').textContent =
    `${currentFilialName} —Ñ–æ—Ä–º–∞ –∞—É–¥–∏—Ç–∞ —Ñ–∏–ª–∏–∞–ª–∞`;
  document.getElementById('mainTitle').style.display = 'block';
  document.getElementById('auditForm').style.display = 'block';

  populateTable();
});

// Submit (fetch)


 

function setInvalidState(inputEl, isInvalid) {
  inputEl.classList.toggle('invalid', isInvalid);
  const td = inputEl.closest('td');
  if (td) td.classList.toggle('invalid-cell', isInvalid);
}
document.getElementById('auditForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const scoreInputs = Array.from(document.querySelectorAll('.score-input'));
  scoreInputs.forEach(inp => setInvalidState(inp, false));

  const firstEmpty = scoreInputs.find(inp => inp.value.trim() === '');
  if (firstEmpty) {
  setInvalidState(firstEmpty, true);
  firstEmpty.scrollIntoView({ behavior: 'smooth', block: 'center' });
  setTimeout(() => firstEmpty.focus(), 250);
  return;
  }

  const formData = new FormData(this);
  const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

  fetch(this.action, {
    method: 'POST',
    body: formData,
    headers: {
      'X-CSRFToken': csrfToken
    },
    credentials: 'same-origin' // ‚úÖ SHART
  })
  .then(r => {
    if (!r.ok) throw new Error('Xatolik yuz berdi');
    return r.text();
  })
  .then(() => window.location.href = successUrl)
  .catch(err => console.error(err));
});




// Enter -> start
document.getElementById('filialInput').addEventListener('keydown', (e) => {
  if (e.key === 'Enter') {
    e.preventDefault();
    document.getElementById('startAuditBtn').click();
  }
});
// overlay ochiq bo'lsa base action-barni yashiramiz
const baseActionBar = document.querySelector('.action-bar');
const overlay = document.getElementById('filialInputOverlay');

function toggleBaseBar() {
  if (!baseActionBar || !overlay) return;
  baseActionBar.style.display = (overlay.style.display == 'none') ? 'none' : '';
}
toggleBaseBar();

 
</script>
{% endblock %}
